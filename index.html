<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>입시 결과 필터 앱 (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useMemo } = React;

      // --- Supabase 클라이언트 (사용자 제공 값 적용) ---
      const SUPABASE_URL = "https://jnknkyxsclytdcskdidt.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impua25reXhzY2x5dGRjc2tkaWR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MjQ5MjksImV4cCI6MjA3MTMwMDkyOX0.VgA458wK1I3N7f5OFkgHIR4qUdKsfruw6HS3z2KxgmQ";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const BUCKET = "admissions";

      function AdmissionsFilterApp() {
        const [rawRows, setRawRows] = useState([]);
        const [fileName, setFileName] = useState("");
        const [error, setError] = useState("");
        const [uploadPath, setUploadPath] = useState("");

        const [year, setYear] = useState("2025");
        const [track, setTrack] = useState("");
        const [region, setRegion] = useState("");
        const [scheme, setScheme] = useState("");
        const [scoreType, setScoreType] = useState("국영수");
        const [cutoff, setCutoff] = useState("");
        const [unitQuery, setUnitQuery] = useState("");

        const [availableFiles, setAvailableFiles] = useState([]);
        const [selectedPath, setSelectedPath] = useState("");

        function extractRegion(univ) {
          const m = /\(([^)]+)\)/.exec(String(univ || ""));
          return m ? m[1].trim() : "";
        }
        function extractScheme(subtype) {
          const s = String(subtype || "");
          if (s.includes("교과")) return "교과전형";
          if (s.includes("종합")) return "종합전형";
          return "기타";
        }
        function parseScore(raw) {
          const text = String(raw ?? "").trim();
          const num = Number(text.replace(/[^\d.\-]/g, ""));
          return { num, text };
        }

        async function handleUpload(ev) {
          const file = ev.target.files?.[0];
          if (!file) return;
          setError("");
          setFileName(file.name);
          try {
            // 1) 로컬 즉시 파싱
            const buf = await file.arrayBuffer();
            const wb = XLSX.read(buf, { type: "array" });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
            setRawRows(Array.isArray(json) ? json : []);

            // 2) Supabase 업로드
            const path = `uploads/${Date.now()}_${file.name}`;
            const { error } = await supabase.storage.from(BUCKET).upload(path, file, {
              cacheControl: "3600", upsert: false, contentType: file.type || "application/octet-stream",
            });
            if (error) throw error;
            setUploadPath(path);
          } catch (err) {
            console.error(err);
            setError("업로드/파싱 실패: 버킷(admissions) 생성/권한 또는 파일형식을 확인하세요.");
            setRawRows([]);
            setUploadPath("");
          } finally {
            ev.target.value = "";
          }
        }

        async function refreshFileList() {
          setAvailableFiles([]);
          const { data, error } = await supabase.storage.from(BUCKET).list("uploads", {
            limit: 100, sortBy: { column: "created_at", order: "desc" }
          });
          if (error) { setError("목록 실패: 버킷/권한 확인"); return; }
          const withPath = (data || []).map(x => ({ ...x, path: `uploads/${x.name}` }));
          setAvailableFiles(withPath);
        }

        async function loadSelected() {
          if (!selectedPath) return;
          const { data, error } = await supabase.storage.from(BUCKET).download(selectedPath);
          if (error) { setError("다운로드 실패: 권한/경로 확인"); return; }
          const buf = await data.arrayBuffer();
          const wb = XLSX.read(buf, { type: "array" });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
          setRawRows(Array.isArray(json) ? json : []);
          setFileName(selectedPath.split("/").pop());
        }

        const filtered = useMemo(() => {
          if (!rawRows.length) return [];
          const okResults = new Set(["합격", "충원합격"]);
          const cutoffNum = cutoff === "" ? Number.POSITIVE_INFINITY : Number(cutoff);

          const needle = unitQuery.trim();
          const enableUnit = needle.length >= 2;
          const needleLower = needle.toLowerCase();

          return rawRows.filter((r) => {
            if (String(r["학년도"] ?? "").trim() !== year) return false;
            if (!okResults.has(String(r["합불"] ?? "").trim())) return false;
            if (track && String(r["계열"] ?? "").trim() !== track) return false;
            if (region && extractRegion(String(r["대학명"] ?? "")) !== region) return false;
            if (scheme && extractScheme(String(r["세부유형"] ?? "")) !== scheme) return false;
            if (enableUnit) {
              const u = String(r["모집단위"] ?? "");
              if (!u.toLowerCase().includes(needleLower)) return false;
            }
            const { num, text } = parseScore(r[scoreType]);
            if (text === "") return false;
            if (!Number.isFinite(num)) return false;
            if (num > cutoffNum) return false;
            return true;
          });
        }, [rawRows, year, track, region, scheme, scoreType, cutoff, unitQuery]);

        const resultRows = useMemo(() => {
          const rows = filtered.map((r, i) => {
            const { num, text } = parseScore(r[scoreType]);
            return {
              id: i + 1,
              대학명: String(r["대학명"] ?? ""),
              세부유형: String(r["세부유형"] ?? ""),
              모집단위: String(r["모집단위"] ?? ""),
              성적: text,
              _scoreNum: num,
            };
          });
          return rows.sort((a, b) => {
            const ax = Number.isFinite(a._scoreNum) ? a._scoreNum : -Infinity;
            const bx = Number.isFinite(b._scoreNum) ? b._scoreNum : -Infinity;
            return bx - ax;
          });
        }, [filtered, scoreType]);

        function uniqueTrack() {
          return Array.from(new Set(rawRows.map((r) => String(r["계열"] ?? "").trim()).filter(Boolean)));
        }
        function uniqueRegion() {
          return Array.from(new Set(rawRows.map((r) => extractRegion(String(r["대학명"] ?? ""))).filter(Boolean)));
        }
        function uniqueScheme() {
          return Array.from(new Set(rawRows.map((r) => extractScheme(String(r["세부유형"] ?? ""))).filter(Boolean)));
        }

        return (
          <div className="min-h-screen p-6">
            <div className="max-w-6xl mx-auto space-y-6">
              <header className="flex items-center justify-between">
                <h1 className="text-2xl font-bold">입시 결과 필터 앱 <span className="text-sm text-gray-400">(Supabase)</span></h1>
              </header>

              <section className="bg-white rounded-2xl shadow p-5 space-y-3">
                <div>
                  <label className="block text-sm font-medium mb-2">엑셀 업로드(파싱 + Supabase 저장)</label>
                  <input type="file" accept=".xlsx,.xls,.csv" onChange={handleUpload} className="block w-full text-sm"/>
                  <div className="mt-2 text-sm text-gray-600">
                    {fileName ? <>선택된 파일: <b>{fileName}</b></> : "선택된 파일 없음"}
                  </div>
                  <div className="text-sm text-gray-500 mt-1">현재 로드된 행 수: {rawRows.length.toLocaleString()}</div>
                  {uploadPath && (
                    <div className="mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded p-2">
                      업로드 완료: <code>{uploadPath}</code>
                    </div>
                  )}
                </div>

                <div className="border-t pt-3">
                  <div className="flex items-end gap-2">
                    <button onClick={refreshFileList} className="px-3 py-2 border rounded">Supabase 목록 불러오기</button>
                    <select value={selectedPath} onChange={(e) => setSelectedPath(e.target.value)} className="border rounded p-2">
                      <option value="">(선택)</option>
                      {availableFiles.map((f) => (
                        <option key={f.name} value={f.path}>{f.name}</option>
                      ))}
                    </select>
                    <button onClick={loadSelected} className="px-3 py-2 border rounded">선택 불러오기</button>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">버킷: <b>{BUCKET}</b> / uploads 폴더 기준, 최신 100개</p>
                </div>

                {error && <div className="mt-2 p-2 text-sm text-red-700 bg-red-50 border border-red-200 rounded">{error}</div>}
              </section>

              <section className="bg-white rounded-2xl shadow p-5">
                <h2 className="text-lg font-semibold mb-3">검색 조건</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">학년도</label>
                    <input type="text" value={year} onChange={(e) => setYear(e.target.value)} className="w-full border rounded p-2"/>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">계열</label>
                    <select value={track} onChange={(e) => setTrack(e.target.value)} className="w-full border rounded p-2">
                      <option value="">(전체)</option>
                      {uniqueTrack().map((v) => <option key={v} value={v}>{v}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">지역</label>
                    <select value={region} onChange={(e) => setRegion(e.target.value)} className="w-full border rounded p-2">
                      <option value="">(전체)</option>
                      {uniqueRegion().map((v) => <option key={v} value={v}>{v}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">전형</label>
                    <select value={scheme} onChange={(e) => setScheme(e.target.value)} className="w-full border rounded p-2">
                      <option value="">(전체)</option>
                      {uniqueScheme().map((v) => <option key={v} value={v}>{v}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">성적 종류</label>
                    <select value={scoreType} onChange={(e) => setScoreType(e.target.value)} className="w-full border rounded p-2">
                      <option value="국영수">국영수</option>
                      <option value="국수영사">국수영사</option>
                      <option value="국영수과">국영수과</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">기준 점수 (이하)</label>
                    <input type="number" value={cutoff} onChange={(e) => setCutoff(e.target.value)} className="w-full border rounded p-2" placeholder="예: 3.75"/>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">모집단위 (부분검색, 2자 이상)</label>
                    <input type="text" value={unitQuery} onChange={(e) => setUnitQuery(e.target.value)} className="w-full border rounded p-2" placeholder="예: 의예"/>
                  </div>
                </div>
                <p className="mt-2 text-xs text-gray-500">※ 모집단위 검색어는 2글자 이상 입력 시 적용됩니다.</p>
              </section>

              <section className="bg-white rounded-2xl shadow p-5">
                <h2 className="text-lg font-semibold mb-3">검색 결과 ({resultRows.length}건) — 성적 내림차순</h2>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm border">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="p-2 border">#</th>
                        <th className="p-2 border">대학명</th>
                        <th className="p-2 border">세부유형</th>
                        <th className="p-2 border">모집단위</th>
                        <th className="p-2 border">성적({scoreType})</th>
                      </tr>
                    </thead>
                    <tbody>
                      {resultRows.map((row, idx) => (
                        <tr key={row.id + '-' + idx} className="odd:bg-white even:bg-gray-50">
                          <td className="p-2 border">{idx + 1}</td>
                          <td className="p-2 border">{row.대학명}</td>
                          <td className="p-2 border">{row.세부유형}</td>
                          <td className="p-2 border">{row.모집단위}</td>
                          <td className="p-2 border">{row.성적}</td>
                        </tr>
                      ))}
                      {resultRows.length === 0 && (
                        <tr><td colSpan="5" className="p-6 text-center text-gray-500">조건에 맞는 결과가 없습니다.</td></tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </section>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<AdmissionsFilterApp />);
    </script>
  </body>
</html>
