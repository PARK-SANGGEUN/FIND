<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>ì…ì‹œ ê²°ê³¼ ê²€ìƒ‰ (Viewer)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen">
    <div class="max-w-6xl mx-auto p-5 space-y-5">
      <header class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">ğŸ“Š ì…ì‹œ ê²°ê³¼ ê²€ìƒ‰ (Viewer)</h1>
        <span class="text-xs text-gray-500">Supabase â€¢ ìµœì‹  íŒŒì¼ ìë™ ë¡œë“œ</span>
      </header>

      <!-- ìƒíƒœ í‘œì‹œ -->
      <section class="bg-white rounded-2xl shadow p-5">
        <div id="status" class="text-sm text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘â€¦</div>
        <div id="rowcount" class="text-xs text-gray-500 mt-1"></div>
      </section>

      <!-- ê²€ìƒ‰ ì¡°ê±´ -->
      <section class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-lg font-semibold mb-3">ê²€ìƒ‰ ì¡°ê±´</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">í•™ë…„ë„</label>
            <input id="year" type="text" value="2025" class="w-full border rounded p-2"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ê³„ì—´</label>
            <select id="track" class="w-full border rounded p-2">
              <option value="">(ì „ì²´)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ì§€ì—­</label>
            <select id="region" class="w-full border rounded p-2">
              <option value="">(ì „ì²´)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ì „í˜•</label>
            <select id="scheme" class="w-full border rounded p-2">
              <option value="">(ì „ì²´)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ì„±ì  ì¢…ë¥˜</label>
            <select id="scoreType" class="w-full border rounded p-2">
              <option value="êµ­ì˜ìˆ˜">êµ­ì˜ìˆ˜</option>
              <option value="êµ­ìˆ˜ì˜ì‚¬">êµ­ìˆ˜ì˜ì‚¬</option>
              <option value="êµ­ì˜ìˆ˜ê³¼">êµ­ì˜ìˆ˜ê³¼</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ê¸°ì¤€ ì ìˆ˜ (ì´í•˜)</label>
            <input id="cutoff" type="number" step="0.01" class="w-full border rounded p-2" placeholder="ì˜ˆ: 3.75"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ëª¨ì§‘ë‹¨ìœ„ (ë¶€ë¶„ê²€ìƒ‰, 2ì ì´ìƒ)</label>
            <input id="unitQuery" type="text" class="w-full border rounded p-2" placeholder="ì˜ˆ: ì˜ì˜ˆ"/>
          </div>
        </div>
        <p class="mt-2 text-xs text-gray-500">â€» ì „í˜•ì€ ì„¸ë¶€ìœ í˜•ì— 'êµê³¼'ê°€ í¬í•¨ë˜ë©´ êµê³¼ì „í˜•, 'ì¢…í•©'ì´ í¬í•¨ë˜ë©´ ì¢…í•©ì „í˜•ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤. ì§€ì—­ì€ ëŒ€í•™ëª… ê´„í˜¸ ì† í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
        <div class="mt-3">
          <button id="btnSearch" class="px-4 py-2 rounded bg-blue-600 text-white">ê²€ìƒ‰</button>
        </div>
      </section>

      <!-- ê²°ê³¼ -->
      <section class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-lg font-semibold mb-3">ê²€ìƒ‰ ê²°ê³¼ â€” ì„±ì  ë‚´ë¦¼ì°¨ìˆœ</h2>
        <div id="results" class="overflow-auto">
          <div class="text-gray-500 text-sm">ì¡°ê±´ì„ ì…ë ¥í•˜ê³  [ê²€ìƒ‰]ì„ ëˆ„ë¥´ì„¸ìš”.</div>
        </div>
      </section>
    </div>

    <script>
      // Supabase ì„¤ì •
      const SUPABASE_URL = "https://jnknkyxsclytdcskdidt.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impua25reXhzY2x5dGRjc2tkaWR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MjQ5MjksImV4cCI6MjA3MTMwMDkyOX0.VgA458wK1I3N7f5OFkgHIR4qUdKsfruw6HS3z2KxgmQ";
      const BUCKET = "admissions";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      let allRows = []; // ì „ì²´ ì›ë³¸
      const qs = (id) => document.getElementById(id);

      function extractRegion(univ) {
        const m = /\(([^)]+)\)/.exec(String(univ || ""));
        return m ? m[1].trim() : "";
      }
      function extractScheme(subtype) {
        const s = String(subtype || "");
        if (s.includes("êµê³¼")) return "êµê³¼ì „í˜•";
        if (s.includes("ì¢…í•©")) return "ì¢…í•©ì „í˜•";
        return "ê¸°íƒ€";
      }
      function parseScore(v) {
        const text = String(v ?? "").trim();
        const num = Number(text.replace(/[^\d.\-]/g, ""));
        return { text, num };
      }

      async function loadLatestFile() {
        try {
          qs("status").textContent = "Supabaseì—ì„œ ìµœì‹  íŒŒì¼ í™•ì¸ ì¤‘â€¦";
          const { data, error } = await supabase.storage.from(BUCKET).list("uploads", {
            limit: 1, sortBy: { column: "created_at", order: "desc" }
          });
          if (error) throw error;
          if (!data || !data.length) {
            qs("status").textContent = "âŒ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.";
            return;
          }
          const latestPath = "uploads/" + data[0].name;
          qs("status").textContent = "ë‹¤ìš´ë¡œë“œ ì¤‘: " + latestPath;

          const { data: blob, error: dErr } = await supabase.storage.from(BUCKET).download(latestPath);
          if (dErr) throw dErr;

          const buf = await blob.arrayBuffer();
          const wb = XLSX.read(buf, { type: "array" });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
          allRows = Array.isArray(rows) ? rows : [];

          // ì˜µì…˜ ì±„ìš°ê¸° (ê³„ì—´/ì§€ì—­/ì „í˜•)
          fillOptions("track", Array.from(new Set(allRows.map(r => String(r["ê³„ì—´"] ?? "").trim()).filter(Boolean))).sort());
          fillOptions("region", Array.from(new Set(allRows.map(r => extractRegion(String(r["ëŒ€í•™ëª…"] ?? ""))).filter(Boolean))).sort());
          fillOptions("scheme", Array.from(new Set(allRows.map(r => extractScheme(String(r["ì„¸ë¶€ìœ í˜•"] ?? ""))).filter(Boolean))).sort());

          qs("status").textContent = "âœ… ë¡œë“œ ì™„ë£Œ: " + data[0].name;
          qs("rowcount").textContent = "ì´ í–‰ ìˆ˜: " + allRows.length.toLocaleString();
        } catch (e) {
          console.error(e);
          qs("status").textContent = "âŒ ë¡œë“œ ì‹¤íŒ¨: " + (e?.message || e);
        }
      }

      function fillOptions(selectId, arr) {
        const el = qs(selectId);
        const current = el.value;
        el.innerHTML = '<option value="">(ì „ì²´)</option>';
        arr.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v; opt.textContent = v;
          el.appendChild(opt);
        });
        if ([...el.options].some(o => o.value === current)) el.value = current;
      }

      function search() {
        if (!allRows.length) {
          qs("results").innerHTML = '<div class="text-red-600 text-sm">ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        const year = qs("year").value.trim();
        const track = qs("track").value;
        const region = qs("region").value;
        const scheme = qs("scheme").value;
        const scoreType = qs("scoreType").value;
        const cutoffRaw = qs("cutoff").value.trim();
        const cutoffNum = cutoffRaw === "" ? Number.POSITIVE_INFINITY : Number(cutoffRaw);
        const unitQuery = qs("unitQuery").value.trim().toLowerCase();
        const useUnit = unitQuery.length >= 2;

        const ok = new Set(["í•©ê²©", "ì¶©ì›í•©ê²©"]);

        const hits = allRows.filter(r => {
          if (String(r["í•™ë…„ë„"] ?? "").trim() !== year) return false;
          if (!ok.has(String(r["í•©ë¶ˆ"] ?? "").trim())) return false;
          if (track && String(r["ê³„ì—´"] ?? "").trim() !== track) return false;
          if (region && extractRegion(String(r["ëŒ€í•™ëª…"] ?? "")) !== region) return false;
          if (scheme && extractScheme(String(r["ì„¸ë¶€ìœ í˜•"] ?? "")) !== scheme) return false;
          if (useUnit) {
            const u = String(r["ëª¨ì§‘ë‹¨ìœ„"] ?? "").toLowerCase();
            if (!u.includes(unitQuery)) return false;
          }
          const { text, num } = parseScore(r[scoreType]);
          if (text === "" || !Number.isFinite(num)) return false;
          if (num > cutoffNum) return false; // ê¸°ì¤€ ì´í•˜ë§Œ
          return true;
        }).map((r, i) => {
          const { text, num } = parseScore(r[scoreType]);
          return ({ idx: i+1, ëŒ€í•™ëª…: String(r["ëŒ€í•™ëª…"]??""), ì„¸ë¶€ìœ í˜•: String(r["ì„¸ë¶€ìœ í˜•"]??""), ëª¨ì§‘ë‹¨ìœ„: String(r["ëª¨ì§‘ë‹¨ìœ„"]??""), ì„±ì : text, _num: num });
        });

        // ì„±ì  ë‚´ë¦¼ì°¨ìˆœ
        hits.sort((a,b) => (Number.isFinite(b._num)?b._num:-Infinity) - (Number.isFinite(a._num)?a._num:-Infinity));

        // ë Œë”
        let html = '<div class="text-sm mb-2">ê²€ìƒ‰ ê²°ê³¼ <b>' + hits.length + '</b>ê±´</div>' +
          '<table class="min-w-full text-sm border">' +
          '<thead class="bg-gray-50"><tr>' +
          '<th class="p-2 border">#</th>' +
          '<th class="p-2 border">ëŒ€í•™ëª…</th>' +
          '<th class="p-2 border">ì„¸ë¶€ìœ í˜•</th>' +
          '<th class="p-2 border">ëª¨ì§‘ë‹¨ìœ„</th>' +
          '<th class="p-2 border">ì„±ì (' + scoreType + ')</th>' +
          '</tr></thead><tbody>';

        html += hits.map((row, i) => (
          '<tr class="' + (i%2 ? 'bg-gray-50' : 'bg-white') + '">' +
          '<td class="p-2 border">' + (i+1) + '</td>' +
          '<td class="p-2 border">' + row["ëŒ€í•™ëª…"] + '</td>' +
          '<td class="p-2 border">' + row["ì„¸ë¶€ìœ í˜•"] + '</td>' +
          '<td class="p-2 border">' + row["ëª¨ì§‘ë‹¨ìœ„"] + '</td>' +
          '<td class="p-2 border">' + row["ì„±ì "] + '</td>' +
          '</tr>'
        )).join('');

        if (hits.length === 0) {
          html += '<tr><td class="p-4 text-center text-gray-500" colspan="5">ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }

        html += '</tbody></table>';
        qs("results").innerHTML = html;
      }

      qs("btnSearch").addEventListener("click", search);

      // ì—”í„°ë¡œë„ ê²€ìƒ‰
      ["year","track","region","scheme","scoreType","cutoff","unitQuery"].forEach(id => {
        const el = qs(id);
        if (el) el.addEventListener("keydown", (e) => { if (e.key === "Enter") search(); });
      });

      // ì‹œì‘: ìµœì‹  íŒŒì¼ ë¡œë“œ
      loadLatestFile();
    </script>
  </body>
</html>
