<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>입시 결과 검색 (Viewer)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen">
    <div class="max-w-6xl mx-auto p-5 space-y-5">
      <header class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">📊 입시 결과 검색 (Viewer)</h1>
        <span class="text-xs text-gray-500">Supabase • 최신 파일 자동 로드</span>
      </header>

      <!-- 상태 표시 -->
      <section class="bg-white rounded-2xl shadow p-5">
        <div id="status" class="text-sm text-gray-600">데이터 로딩 중…</div>
        <div id="rowcount" class="text-xs text-gray-500 mt-1"></div>
      </section>

      <!-- 검색 조건 -->
      <section class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-lg font-semibold mb-3">검색 조건</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">학년도</label>
            <input id="year" type="text" value="2025" class="w-full border rounded p-2"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">계열</label>
            <select id="track" class="w-full border rounded p-2">
              <option value="">(전체)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">지역</label>
            <select id="region" class="w-full border rounded p-2">
              <option value="">(전체)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">전형</label>
            <select id="scheme" class="w-full border rounded p-2">
              <option value="">(전체)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">성적 종류</label>
            <select id="scoreType" class="w-full border rounded p-2">
              <option value="국영수">국영수</option>
              <option value="국수영사">국수영사</option>
              <option value="국영수과">국영수과</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">기준 점수 (이하)</label>
            <input id="cutoff" type="number" step="0.01" class="w-full border rounded p-2" placeholder="예: 3.75"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">모집단위 (부분검색, 2자 이상)</label>
            <input id="unitQuery" type="text" class="w-full border rounded p-2" placeholder="예: 의예"/>
          </div>
        </div>
        <p class="mt-2 text-xs text-gray-500">※ 전형은 세부유형에 '교과'가 포함되면 교과전형, '종합'이 포함되면 종합전형으로 분류합니다. 지역은 대학명 괄호 속 텍스트를 사용합니다.</p>
        <div class="mt-3">
          <button id="btnSearch" class="px-4 py-2 rounded bg-blue-600 text-white">검색</button>
        </div>
      </section>

      <!-- 결과 -->
      <section class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-lg font-semibold mb-3">검색 결과 — 성적 내림차순</h2>
        <div id="results" class="overflow-auto">
          <div class="text-gray-500 text-sm">조건을 입력하고 [검색]을 누르세요.</div>
        </div>
      </section>
    </div>

    <script>
      // Supabase 설정
      const SUPABASE_URL = "https://jnknkyxsclytdcskdidt.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impua25reXhzY2x5dGRjc2tkaWR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MjQ5MjksImV4cCI6MjA3MTMwMDkyOX0.VgA458wK1I3N7f5OFkgHIR4qUdKsfruw6HS3z2KxgmQ";
      const BUCKET = "admissions";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      let allRows = []; // 전체 원본
      const qs = (id) => document.getElementById(id);

      function extractRegion(univ) {
        const m = /\(([^)]+)\)/.exec(String(univ || ""));
        return m ? m[1].trim() : "";
      }
      function extractScheme(subtype) {
        const s = String(subtype || "");
        if (s.includes("교과")) return "교과전형";
        if (s.includes("종합")) return "종합전형";
        return "기타";
      }
      function parseScore(v) {
        const text = String(v ?? "").trim();
        const num = Number(text.replace(/[^\d.\-]/g, ""));
        return { text, num };
      }

      async function loadLatestFile() {
        try {
          qs("status").textContent = "Supabase에서 최신 파일 확인 중…";
          const { data, error } = await supabase.storage.from(BUCKET).list("uploads", {
            limit: 1, sortBy: { column: "created_at", order: "desc" }
          });
          if (error) throw error;
          if (!data || !data.length) {
            qs("status").textContent = "❌ 업로드된 파일이 없습니다.";
            return;
          }
          const latestPath = "uploads/" + data[0].name;
          qs("status").textContent = "다운로드 중: " + latestPath;

          const { data: blob, error: dErr } = await supabase.storage.from(BUCKET).download(latestPath);
          if (dErr) throw dErr;

          const buf = await blob.arrayBuffer();
          const wb = XLSX.read(buf, { type: "array" });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
          allRows = Array.isArray(rows) ? rows : [];

          // 옵션 채우기 (계열/지역/전형)
          fillOptions("track", Array.from(new Set(allRows.map(r => String(r["계열"] ?? "").trim()).filter(Boolean))).sort());
          fillOptions("region", Array.from(new Set(allRows.map(r => extractRegion(String(r["대학명"] ?? ""))).filter(Boolean))).sort());
          fillOptions("scheme", Array.from(new Set(allRows.map(r => extractScheme(String(r["세부유형"] ?? ""))).filter(Boolean))).sort());

          qs("status").textContent = "✅ 로드 완료: " + data[0].name;
          qs("rowcount").textContent = "총 행 수: " + allRows.length.toLocaleString();
        } catch (e) {
          console.error(e);
          qs("status").textContent = "❌ 로드 실패: " + (e?.message || e);
        }
      }

      function fillOptions(selectId, arr) {
        const el = qs(selectId);
        const current = el.value;
        el.innerHTML = '<option value="">(전체)</option>';
        arr.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v; opt.textContent = v;
          el.appendChild(opt);
        });
        if ([...el.options].some(o => o.value === current)) el.value = current;
      }

      function search() {
        if (!allRows.length) {
          qs("results").innerHTML = '<div class="text-red-600 text-sm">데이터가 아직 로드되지 않았습니다.</div>';
          return;
        }
        const year = qs("year").value.trim();
        const track = qs("track").value;
        const region = qs("region").value;
        const scheme = qs("scheme").value;
        const scoreType = qs("scoreType").value;
        const cutoffRaw = qs("cutoff").value.trim();
        const cutoffNum = cutoffRaw === "" ? Number.POSITIVE_INFINITY : Number(cutoffRaw);
        const unitQuery = qs("unitQuery").value.trim().toLowerCase();
        const useUnit = unitQuery.length >= 2;

        const ok = new Set(["합격", "충원합격"]);

        const hits = allRows.filter(r => {
          if (String(r["학년도"] ?? "").trim() !== year) return false;
          if (!ok.has(String(r["합불"] ?? "").trim())) return false;
          if (track && String(r["계열"] ?? "").trim() !== track) return false;
          if (region && extractRegion(String(r["대학명"] ?? "")) !== region) return false;
          if (scheme && extractScheme(String(r["세부유형"] ?? "")) !== scheme) return false;
          if (useUnit) {
            const u = String(r["모집단위"] ?? "").toLowerCase();
            if (!u.includes(unitQuery)) return false;
          }
          const { text, num } = parseScore(r[scoreType]);
          if (text === "" || !Number.isFinite(num)) return false;
          if (num > cutoffNum) return false; // 기준 이하만
          return true;
        }).map((r, i) => {
          const { text, num } = parseScore(r[scoreType]);
          return ({ idx: i+1, 대학명: String(r["대학명"]??""), 세부유형: String(r["세부유형"]??""), 모집단위: String(r["모집단위"]??""), 성적: text, _num: num });
        });

        // 성적 내림차순
        hits.sort((a,b) => (Number.isFinite(b._num)?b._num:-Infinity) - (Number.isFinite(a._num)?a._num:-Infinity));

        // 렌더
        let html = '<div class="text-sm mb-2">검색 결과 <b>' + hits.length + '</b>건</div>' +
          '<table class="min-w-full text-sm border">' +
          '<thead class="bg-gray-50"><tr>' +
          '<th class="p-2 border">#</th>' +
          '<th class="p-2 border">대학명</th>' +
          '<th class="p-2 border">세부유형</th>' +
          '<th class="p-2 border">모집단위</th>' +
          '<th class="p-2 border">성적(' + scoreType + ')</th>' +
          '</tr></thead><tbody>';

        html += hits.map((row, i) => (
          '<tr class="' + (i%2 ? 'bg-gray-50' : 'bg-white') + '">' +
          '<td class="p-2 border">' + (i+1) + '</td>' +
          '<td class="p-2 border">' + row["대학명"] + '</td>' +
          '<td class="p-2 border">' + row["세부유형"] + '</td>' +
          '<td class="p-2 border">' + row["모집단위"] + '</td>' +
          '<td class="p-2 border">' + row["성적"] + '</td>' +
          '</tr>'
        )).join('');

        if (hits.length === 0) {
          html += '<tr><td class="p-4 text-center text-gray-500" colspan="5">조건에 맞는 결과가 없습니다.</td></tr>';
        }

        html += '</tbody></table>';
        qs("results").innerHTML = html;
      }

      qs("btnSearch").addEventListener("click", search);

      // 엔터로도 검색
      ["year","track","region","scheme","scoreType","cutoff","unitQuery"].forEach(id => {
        const el = qs(id);
        if (el) el.addEventListener("keydown", (e) => { if (e.key === "Enter") search(); });
      });

      // 시작: 최신 파일 로드
      loadLatestFile();
    </script>
  </body>
</html>
